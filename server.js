const express = require('express');
const mysql = require('mysql');
const cors = require('cors');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const multer = require('multer');
const path = require('path');
const { S3Client, PutObjectCommand, DeleteObjectCommand, GetObjectCommand } = require('@aws-sdk/client-s3');
const { Upload } = require('@aws-sdk/lib-storage');
const axios = require('axios');

const app = express();
app.use(cors());
app.use(express.json());

// Hardcoded sensitive data (not recommended for production)
const JWT_SECRET = process.env.JWT_SECRET || 'your_jwt_secret_key_very_secure_random_string';
const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '7858016810:AAELHxlmZORP7iHEIWdqYKw-rHl-q3aB8yY';

// S3 Configuration
const s3Client = new S3Client({
  credentials: {
    accessKeyId: process.env.S3_ACCESS_KEY || 'GIMZKRMOGP4F0MOTLVCE',
    secretAccessKey: process.env.S3_SECRET_KEY || 'WvhFfIzzCkITUrXfD8JfoDne7LmBhnNzDuDBj89I',
  },
  endpoint: 'https://s3.twcstorage.ru',
  region: 'ru-1',
  forcePathStyle: true,
});
const S3_BUCKET = 'a2c31109-3cf2c97b-aca1-42b0-a822-3e0ade279447';

// Test S3 Connection
function testS3Connection(callback) {
  const command = new PutObjectCommand({
    Bucket: S3_BUCKET,
    Key: 'test-connection.txt',
    Body: 'This is a test file to check S3 connection.',
  });
  s3Client.send(command, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ S3:', err.stack);
      callback(new Error(`S3 connection failed: ${err.message}`));
    } else {
      console.log('–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ S3 –∏ —Å–æ–∑–¥–∞–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª!');
      callback(null);
    }
  });
}

// Multer setup for image uploads
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB limit
  },
}).single('image');

// Upload to S3
function uploadToS3(file, callback) {
  const key = `pizza-images/${Date.now()}${path.extname(file.originalname)}`;
  const params = {
    Bucket: S3_BUCKET,
    Key: key,
    Body: file.buffer,
    ContentType: file.mimetype,
  };
  const upload = new Upload({ client: s3Client, params });
  upload.done()
    .then(() => callback(null, key))
    .catch((err) => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
      callback(new Error(`S3 upload failed: ${err.message}`));
    });
}

// Get from S3
function getFromS3(key, callback) {
  const params = {
    Bucket: S3_BUCKET,
    Key: key,
  };
  s3Client.send(new GetObjectCommand(params), (err, data) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑ S3:', err.stack);
      callback(new Error(`S3 retrieval failed: ${err.message}`));
    } else {
      callback(null, data);
    }
  });
}

// Delete from S3
function deleteFromS3(key, callback) {
  const params = {
    Bucket: S3_BUCKET,
    Key: key,
  };
  s3Client.send(new DeleteObjectCommand(params), (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ S3:', err.stack);
      callback(new Error(`S3 deletion failed: ${err.message}`));
    } else {
      console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ S3:', key);
      callback(null);
    }
  });
}

// MySQL Connection
const db = mysql.createPool({
  host: 'vh446.timeweb.ru',
  user: 'cz45780_pizzaame',
  password: 'Vasya11091109',
  database: 'cz45780_pizzaame',
});

// Middleware for token authentication
function authenticateToken(req, res, next) {
  const token = req.headers['authorization']?.split(' ')[1];
  if (!token) return res.status(401).json({ error: '–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' });
  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) return res.status(403).json({ error: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω' });
    req.user = user;
    next();
  });
}

// Optional authentication for image routes
function optionalAuthenticateToken(req, res, next) {
  const token = req.headers['authorization']?.split(' ')[1];
  if (token) {
    jwt.verify(token, JWT_SECRET, (err, user) => {
      if (!err) req.user = user;
      next();
    });
  } else {
    next();
  }
}

// Route to get image by key
app.get('/product-image/:key', optionalAuthenticateToken, (req, res) => {
  const { key } = req.params;
  getFromS3(`pizza-images/${key}`, (err, image) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    res.setHeader('Content-Type', image.ContentType || 'image/jpeg');
    image.Body.pipe(res);
  });
});

// Initialize server
function initializeServer(callback) {
  // Test MySQL connection
  db.getConnection((err, connection) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL:', err.stack);
      return callback(new Error(`MySQL connection failed: ${err.message}`));
    }

    connection.query('SELECT 1', (err) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL:', err.stack);
        connection.release();
        return callback(new Error(`MySQL connection test failed: ${err.message}`));
      }
      console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ MySQL');

      // Create tables and initialize data
      connection.query(`
        CREATE TABLE IF NOT EXISTS branches (
          id INT AUTO_INCREMENT PRIMARY KEY,
          name VARCHAR(255) NOT NULL,
          address VARCHAR(255),
          phone VARCHAR(20),
          telegram_chat_id VARCHAR(50),
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
      `, (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã branches:', err.stack);
          connection.release();
          return callback(err);
        }
        console.log('–¢–∞–±–ª–∏—Ü–∞ branches –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');

        // Add columns to branches if missing
        connection.query('SHOW COLUMNS FROM branches LIKE "address"', (err, branchColumns) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ branches:', err.stack);
            connection.release();
            return callback(err);
          }
          if (branchColumns.length === 0) {
            connection.query('ALTER TABLE branches ADD COLUMN address VARCHAR(255), ADD COLUMN phone VARCHAR(20)', (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ branches:', err.stack);
                connection.release();
                return callback(err);
              }
              console.log('–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ address –∏ phone –≤ —Ç–∞–±–ª–∏—Ü—É branches');
            });
          }

          connection.query('SHOW COLUMNS FROM branches LIKE "telegram_chat_id"', (err, telegramColumns) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–∫–∏ telegram_chat_id:', err.stack);
              connection.release();
              return callback(err);
            }
            if (telegramColumns.length === 0) {
              connection.query('ALTER TABLE branches ADD COLUMN telegram_chat_id VARCHAR(50)', (err) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ telegram_chat_id:', err.stack);
                  connection.release();
                  return callback(err);
                }
                console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ telegram_chat_id –≤ —Ç–∞–±–ª–∏—Ü—É branches');
              });
            }

            // Initialize branches
            connection.query('SELECT * FROM branches', (err, branches) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–æ–≤:', err.stack);
                connection.release();
                return callback(err);
              }
              if (branches.length === 0) {
                const insertBranches = [
                  ['BOODAI PIZZA', '-1002311447135'],
                  ['–†–∞–π–æ–Ω', '-1002638475628'],
                  ['–ê—Ä–∞–≤–∞–Ω—Å–∫–∏–π', '-1002311447135'],
                  ['–û—à—Å–∫–∏–π —Ä–∞–π–æ–Ω', '-1002638475628'],
                ];
                let inserted = 0;
                insertBranches.forEach(([name, telegram_chat_id], index) => {
                  connection.query(
                    'INSERT INTO branches (name, telegram_chat_id) VALUES (?, ?)',
                    [name, telegram_chat_id],
                    (err) => {
                      if (err) {
                        console.error('–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ñ–∏–ª–∏–∞–ª–∞:', err.stack);
                        connection.release();
                        return callback(err);
                      }
                      inserted++;
                      if (inserted === insertBranches.length) {
                        console.log('–î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–∏–ª–∏–∞–ª—ã —Å telegram_chat_id');
                        continueInitialization();
                      }
                    }
                  );
                });
              } else {
                const updateQueries = [
                  ['BOODAI PIZZA', '-1002311447135'],
                  ['–†–∞–π–æ–Ω', '-1002638475628'],
                  ['–ê—Ä–∞–≤–∞–Ω—Å–∫–∏–π', '-1002311447135'],
                  ['–û—à—Å–∫–∏–π —Ä–∞–π–æ–Ω', '-1002638475628'],
                ];
                let updated = 0;
                updateQueries.forEach(([name, telegram_chat_id]) => {
                  connection.query(
                    'UPDATE branches SET telegram_chat_id = ? WHERE name = ? AND (telegram_chat_id IS NULL OR telegram_chat_id = "")',
                    [telegram_chat_id, name],
                    (err) => {
                      if (err) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è telegram_chat_id:', err.stack);
                        connection.release();
                        return callback(err);
                      }
                      updated++;
                      if (updated === updateQueries.length) {
                        console.log('–û–±–Ω–æ–≤–ª–µ–Ω—ã telegram_chat_id –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤');
                        continueInitialization();
                      }
                    }
                  );
                });
              }
            });
          });
        });
      });

      function continueInitialization() {
        // Check telegram_chat_id for branches
        connection.query('SELECT id, name, telegram_chat_id FROM branches', (err, branches) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ telegram_chat_id:', err.stack);
            connection.release();
            return callback(err);
          }
          branches.forEach(branch => {
            if (!branch.telegram_chat_id) {
              console.warn(`–§–∏–ª–∏–∞–ª "${branch.name}" (id: ${branch.id}) –Ω–µ –∏–º–µ–µ—Ç telegram_chat_id. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.`);
            }
          });

          // Add columns to products if missing
          connection.query('SHOW COLUMNS FROM products', (err, productColumns) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ products:', err.stack);
              connection.release();
              return callback(err);
            }
            const columns = productColumns.map(col => col.Field);
            let productAlterations = 0;
            const checkProductAlterations = () => {
              productAlterations++;
              if (productAlterations === 3) createSubcategoriesTable();
            };
            if (!columns.includes('mini_recipe')) {
              connection.query('ALTER TABLE products ADD COLUMN mini_recipe TEXT', (err) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ mini_recipe:', err.stack);
                  connection.release();
                  return callback(err);
                }
                console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ mini_recipe –≤ —Ç–∞–±–ª–∏—Ü—É products');
                checkProductAlterations();
              });
            } else {
              checkProductAlterations();
            }
            if (!columns.includes('sub_category_id')) {
              connection.query('ALTER TABLE products ADD COLUMN sub_category_id INT', (err) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ sub_category_id:', err.stack);
                  connection.release();
                  return callback(err);
                }
                console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ sub_category_id –≤ —Ç–∞–±–ª–∏—Ü—É products');
                checkProductAlterations();
              });
            } else {
              checkProductAlterations();
            }
            if (!columns.includes('is_pizza')) {
              connection.query('ALTER TABLE products ADD COLUMN is_pizza BOOLEAN DEFAULT FALSE', (err) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ is_pizza:', err.stack);
                  connection.release();
                  return callback(err);
                }
                console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ is_pizza –≤ —Ç–∞–±–ª–∏—Ü—É products');
                checkProductAlterations();
              });
            } else {
              checkProductAlterations();
            }
          });
        });
      }

      function createSubcategoriesTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS subcategories (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            category_id INT NOT NULL,
            FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã subcategories:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ subcategories –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createPromoCodesTable();
        });
      }

      function createPromoCodesTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS promo_codes (
            id INT AUTO_INCREMENT PRIMARY KEY,
            code VARCHAR(50) NOT NULL UNIQUE,
            discount_percent INT NOT NULL,
            expires_at TIMESTAMP NULL DEFAULT NULL,
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã promo_codes:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ promo_codes –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createOrdersTable();
        });
      }

      function createOrdersTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS orders (
            id INT AUTO_INCREMENT PRIMARY KEY,
            branch_id INT NOT NULL,
            total DECIMAL(10,2) NOT NULL,
            status ENUM('pending', 'processing', 'completed', 'cancelled') DEFAULT 'pending',
            order_details JSON,
            delivery_details JSON,
            cart_items JSON,
            discount INT DEFAULT 0,
            promo_code VARCHAR(50),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (branch_id) REFERENCES branches(id) ON DELETE CASCADE
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã orders:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ orders –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createStoriesTable();
        });
      }

      function createStoriesTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS stories (
            id INT AUTO_INCREMENT PRIMARY KEY,
            image VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã stories:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ stories –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createDiscountsTable();
        });
      }

      function createDiscountsTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS discounts (
            id INT AUTO_INCREMENT PRIMARY KEY,
            product_id INT NOT NULL,
            discount_percent INT NOT NULL,
            expires_at TIMESTAMP NULL DEFAULT NULL,
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã discounts:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ discounts –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createBannersTable();
        });
      }

      function createBannersTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS banners (
            id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            image VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            title VARCHAR(255) DEFAULT NULL,
            description TEXT DEFAULT NULL,
            button_text VARCHAR(100) DEFAULT NULL,
            promo_code_id INT DEFAULT NULL,
            FOREIGN KEY (promo_code_id) REFERENCES promo_codes(id) ON DELETE SET NULL
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã banners:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ banners –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createSaucesTable();
        });
      }

      function createSaucesTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS sauces (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            price DECIMAL(10,2) NOT NULL,
            image VARCHAR(255) DEFAULT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã sauces:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ sauces –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          createProductsSaucesTable();
        });
      }

      function createProductsSaucesTable() {
        connection.query(`
          CREATE TABLE IF NOT EXISTS products_sauces (
            product_id INT NOT NULL,
            sauce_id INT NOT NULL,
            PRIMARY KEY (product_id, sauce_id),
            FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
            FOREIGN KEY (sauce_id) REFERENCES sauces(id) ON DELETE CASCADE
          )
        `, (err) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã products_sauces:', err.stack);
            connection.release();
            return callback(err);
          }
          console.log('–¢–∞–±–ª–∏—Ü–∞ products_sauces –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞');
          addDiscountColumns();
        });
      }

      function addDiscountColumns() {
        connection.query('SHOW COLUMNS FROM discounts', (err, discountColumns) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ discounts:', err.stack);
            connection.release();
            return callback(err);
          }
          const discountFields = discountColumns.map(col => col.Field);
          let discountAlterations = 0;
          const checkDiscountAlterations = () => {
            discountAlterations++;
            if (discountAlterations === 2) createAdminUser();
          };
          if (!discountFields.includes('expires_at')) {
            connection.query('ALTER TABLE discounts ADD COLUMN expires_at TIMESTAMP NULL DEFAULT NULL', (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ expires_at:', err.stack);
                connection.release();
                return callback(err);
              }
              console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ expires_at –≤ —Ç–∞–±–ª–∏—Ü—É discounts');
              checkDiscountAlterations();
            });
          } else {
            checkDiscountAlterations();
          }
          if (!discountFields.includes('is_active')) {
            connection.query('ALTER TABLE discounts ADD COLUMN is_active BOOLEAN DEFAULT TRUE', (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ is_active:', err.stack);
                connection.release();
                return callback(err);
              }
              console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ is_active –≤ —Ç–∞–±–ª–∏—Ü—É discounts');
              checkDiscountAlterations();
            });
          } else {
            checkDiscountAlterations();
          }
        });
      }

      function createAdminUser() {
        connection.query('SELECT * FROM users WHERE email = ?', ['admin@boodaypizza.com'], (err, users) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', err.stack);
            connection.release();
            return callback(err);
          }
          if (users.length === 0) {
            bcrypt.hash('admin123', 10, (err, hashedPassword) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è:', err.stack);
                connection.release();
                return callback(err);
              }
              connection.query(
                'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
                ['Admin', 'admin@boodaypizza.com', hashedPassword],
                (err) => {
                  if (err) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∞:', err.stack);
                    connection.release();
                    return callback(err);
                  }
                  console.log('–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω: admin@boodaypizza.com / admin123');
                  connection.release();
                  testS3Connection(callback);
                }
              );
            });
          } else {
            console.log('–ê–¥–º–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: admin@boodaypizza.com');
            connection.release();
            testS3Connection(callback);
          }
        });
      }
    });
  });
}

// Public routes
app.get('/api/public/branches', (req, res) => {
  db.query('SELECT id, name, address FROM branches', (err, branches) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(branches);
  });
});

app.get('/api/public/branches/:branchId/products', (req, res) => {
  const { branchId } = req.params;
  db.query(`
    SELECT p.id, p.name, p.description, p.price_small, p.price_medium, p.price_large,
           p.price_single AS price, p.image AS image_url, c.name AS category,
           d.discount_percent, d.expires_at,
           COALESCE(
             (SELECT JSON_ARRAYAGG(
               JSON_OBJECT(
                 'id', s.id,
                 'name', s.name,
                 'price', s.price,
                 'image', s.image
               )
             )
             FROM products_sauces ps
             LEFT JOIN sauces s ON ps.sauce_id = s.id
             WHERE ps.product_id = p.id AND s.id IS NOT NULL),
             '[]'
           ) as sauces
    FROM products p
    LEFT JOIN categories c ON p.category_id = c.id
    LEFT JOIN discounts d ON p.id = d.product_id AND d.is_active = TRUE AND (d.expires_at IS NULL OR d.expires_at > NOW())
    WHERE p.branch_id = ?
    GROUP BY p.id
  `, [branchId], (err, products) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const parsedProducts = products.map(product => {
      let sauces = [];
      try {
        sauces = product.sauces ? JSON.parse(product.sauces).filter(s => s && s.id) : [];
      } catch (parseError) {
        console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${product.id}:`, parseError.stack);
        sauces = [];
      }
      return { ...product, sauces };
    });
    res.json(parsedProducts);
  });
});

app.get('/api/public/branches/:branchId/orders', (req, res) => {
  const { branchId } = req.params;
  db.query(`
    SELECT id, total, created_at, status
    FROM orders
    WHERE branch_id = ?
    ORDER BY created_at DESC
    LIMIT 10
  `, [branchId], (err, orders) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(orders);
  });
});

app.get('/api/public/stories', (req, res) => {
  db.query('SELECT * FROM stories', (err, stories) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–π:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const storiesWithUrls = stories.map(story => ({
      ...story,
      image: `https://nukesul-brepb-651f.twc1.net/product-image/${story.image.split('/').pop()}`
    }));
    res.json(storiesWithUrls);
  });
});

app.get('/api/public/banners', (req, res) => {
  db.query(`
    SELECT b.id, b.image, b.created_at, b.title, b.description, b.button_text,
           pc.code AS promo_code, pc.discount_percent
    FROM banners b
    LEFT JOIN promo_codes pc ON b.promo_code_id = pc.id
    WHERE pc.is_active = TRUE OR pc.id IS NULL
  `, (err, banners) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const bannersWithUrls = banners.map(banner => ({
      ...banner,
      image: `https://nukesul-brepb-651f.twc1.net/product-image/${banner.image.split('/').pop()}`
    }));
    res.json(bannersWithUrls);
  });
});

app.post('/api/public/validate-promo', (req, res) => {
  const { promoCode } = req.body;
  db.query(`
    SELECT discount_percent AS discount
    FROM promo_codes
    WHERE code = ? AND is_active = TRUE AND (expires_at IS NULL OR expires_at > NOW())
  `, [promoCode], (err, promo) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (promo.length === 0) {
      return res.status(400).json({ error: '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω' });
    }
    res.json({ discount: promo[0].discount });
  });
});

app.post('/api/public/send-order', (req, res) => {
  const { orderDetails, deliveryDetails, cartItems, discount, promoCode, branchId } = req.body;
  if (!cartItems || !Array.isArray(cartItems) || cartItems.length === 0) {
    return res.status(400).json({ error: '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
  }
  if (!branchId) {
    return res.status(400).json({ error: '–ù–µ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª–∏–∞–ª (branchId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)' });
  }
  const total = cartItems.reduce((sum, item) => sum + (Number(item.originalPrice) || 0) * item.quantity, 0);
  const discountedTotal = total * (1 - (discount || 0) / 100);
  const escapeMarkdown = (text) => (text ? text.replace(/([_*[\]()~`>#+-.!])/g, '\\$1') : '–ù–µ—Ç');
  const orderText = `
üì¶ *–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:*
üè™ –§–∏–ª–∏–∞–ª: ${escapeMarkdown(branchName)}
üë§ –ò–º—è: ${escapeMarkdown(orderDetails.name || deliveryDetails.name)}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${escapeMarkdown(orderDetails.phone || deliveryDetails.phone)}
üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${escapeMarkdown(orderDetails.comments || deliveryDetails.comments || "–ù–µ—Ç")}
üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ${escapeMarkdown(deliveryDetails.address || "–°–∞–º–æ–≤—ã–≤–æ–∑")}
üõí *–¢–æ–≤–∞—Ä—ã:*
${cartItems.map((item) => `- ${escapeMarkdown(item.name)} (${item.quantity} —à—Ç. –ø–æ ${item.originalPrice} —Å–æ–º)`).join('\n')}
üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${total.toFixed(2)} —Å–æ–º
${promoCode ? `üí∏ –°–∫–∏–¥–∫–∞ (${discount}%): ${discountedTotal.toFixed(2)} —Å–æ–º` : 'üí∏ –°–∫–∏–¥–∫–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞'}
üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${discountedTotal.toFixed(2)} —Å–æ–º
  `;
  db.query(
    `
    INSERT INTO orders (branch_id, total, status, order_details, delivery_details, cart_items, discount, promo_code)
    VALUES (?, ?, 'pending', ?, ?, ?, ?, ?)
  `,
    [
      branchId,
      discountedTotal,
      JSON.stringify(orderDetails),
      JSON.stringify(deliveryDetails),
      JSON.stringify(cartItems),
      discount || 0,
      promoCode || null,
    ],
    (err, result) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      db.query('SELECT name, telegram_chat_id FROM branches WHERE id = ?', [branchId], (err, branch) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        if (branch.length === 0) {
          console.error(`–§–∏–ª–∏–∞–ª —Å id ${branchId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`);
          return res.status(400).json({ error: `–§–∏–ª–∏–∞–ª —Å id ${branchId} –Ω–µ –Ω–∞–π–¥–µ–Ω` });
        }
        const chatId = branch[0].telegram_chat_id;
        if (!chatId) {
          console.error(`–î–ª—è —Ñ–∏–ª–∏–∞–ª–∞ —Å id ${branchId} (–Ω–∞–∑–≤–∞–Ω–∏–µ: ${branch[0].name}) –Ω–µ —É–∫–∞–∑–∞–Ω telegram_chat_id`);
          return res.status(500).json({
            error: `–î–ª—è —Ñ–∏–ª–∏–∞–ª–∞ "${branch[0].name}" –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Telegram chat ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.`,
          });
        }
        console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –≤ Telegram –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ "${branch[0].name}" (id: ${branchId}, chat_id: ${chatId})`);
        axios.post(
          `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
          {
            chat_id: chatId,
            text: orderText,
            parse_mode: 'Markdown',
          }
        ).then(response => {
          console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram:', response.data);
          res.status(200).json({ message: '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', orderId: result.insertId });
        }).catch(telegramError => {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', telegramError.stack);
          const errorDescription = telegramError.response?.data?.description || telegramError.message;
          if (telegramError.response?.data?.error_code === 403) {
            return res.status(500).json({
              error: `–ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—É (chat_id: ${chatId}). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.`,
            });
          }
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: ${errorDescription}` });
        });
      });
    }
  );
});

// Admin routes
app.get('/', (req, res) => res.send('Booday Pizza API'));

app.post('/admin/login', (req, res) => {
  const { email, password } = req.body;
  if (!email || !password) return res.status(400).json({ error: '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å' });
  db.query('SELECT * FROM users WHERE email = ?', [email], (err, users) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (users.length === 0) return res.status(401).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
    const user = users[0];
    bcrypt.compare(password, user.password, (err, isMatch) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (!isMatch) return res.status(401).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
      const token = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '1h' });
      res.json({ token, user: { id: user.id, name: user.name, email: user.email } });
    });
  });
});

app.get('/branches', authenticateToken, (req, res) => {
  db.query('SELECT * FROM branches', (err, branches) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(branches);
  });
});

app.get('/products', authenticateToken, (req, res) => {
  db.query(`
    SELECT p.*,
           b.name as branch_name,
           c.name as category_name,
           s.name as subcategory_name,
           d.discount_percent,
           d.expires_at,
           d.is_active as discount_active,
           COALESCE(
             (SELECT JSON_ARRAYAGG(
               JSON_OBJECT(
                 'id', sa.id,
                 'name', sa.name,
                 'price', sa.price,
                 'image', sa.image
               )
             )
             FROM products_sauces ps
             LEFT JOIN sauces sa ON ps.sauce_id = sa.id
             WHERE ps.product_id = p.id AND sa.id IS NOT NULL),
             '[]'
           ) as sauces
    FROM products p
    LEFT JOIN branches b ON p.branch_id = b.id
    LEFT JOIN categories c ON p.category_id = c.id
    LEFT JOIN subcategories s ON p.sub_category_id = s.id
    LEFT JOIN discounts d ON p.id = d.product_id AND d.is_active = TRUE AND (d.expires_at IS NULL OR d.expires_at > NOW())
    GROUP BY p.id
  `, (err, products) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const parsedProducts = products.map(product => {
      let sauces = [];
      try {
        sauces = product.sauces ? JSON.parse(product.sauces).filter(s => s && s.id) : [];
      } catch (parseError) {
        console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${product.id}:`, parseError.stack);
        sauces = [];
      }
      return { ...product, sauces };
    });
    res.json(parsedProducts);
  });
});

app.get('/discounts', authenticateToken, (req, res) => {
  db.query(`
    SELECT d.*, p.name as product_name
    FROM discounts d
    JOIN products p ON d.product_id = p.id
    WHERE d.is_active = TRUE AND (d.expires_at IS NULL OR d.expires_at > NOW())
  `, (err, discounts) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∫–∏–¥–æ–∫:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(discounts);
  });
});

app.get('/stories', authenticateToken, (req, res) => {
  db.query('SELECT * FROM stories', (err, stories) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–π:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const storiesWithUrls = stories.map(story => ({
      ...story,
      image: `https://nukesul-brepb-651f.twc1.net/product-image/${story.image.split('/').pop()}`
    }));
    res.json(storiesWithUrls);
  });
});

app.get('/banners', authenticateToken, (req, res) => {
  db.query(`
    SELECT b.*, pc.code AS promo_code, pc.discount_percent
    FROM banners b
    LEFT JOIN promo_codes pc ON b.promo_code_id = pc.id
  `, (err, banners) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const bannersWithUrls = banners.map(banner => ({
      ...banner,
      image: `https://nukesul-brepb-651f.twc1.net/product-image/${banner.image.split('/').pop()}`
    }));
    res.json(bannersWithUrls);
  });
});

app.get('/sauces', authenticateToken, (req, res) => {
  db.query('SELECT * FROM sauces', (err, sauces) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—É—Å–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    const saucesWithUrls = sauces.map(sauce => ({
      ...sauce,
      image: sauce.image ? `https://nukesul-brepb-651f.twc1.net/product-image/${sauce.image.split('/').pop()}` : null
    }));
    res.json(saucesWithUrls);
  });
});

app.get('/categories', authenticateToken, (req, res) => {
  db.query('SELECT * FROM categories', (err, categories) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(categories);
  });
});

app.get('/promo-codes', authenticateToken, (req, res) => {
  db.query('SELECT * FROM promo_codes', (err, promoCodes) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(promoCodes);
  });
});

app.get('/promo-codes/check/:code', authenticateToken, (req, res) => {
  const { code } = req.params;
  db.query(`
    SELECT * FROM promo_codes
    WHERE code = ? AND is_active = TRUE AND (expires_at IS NULL OR expires_at > NOW())
  `, [code], (err, promo) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (promo.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω' });
    res.json(promo[0]);
  });
});

app.post('/promo-codes', authenticateToken, (req, res) => {
  const { code, discountPercent, expiresAt, isActive } = req.body;
  if (!code || !discountPercent) return res.status(400).json({ error: '–ö–æ–¥ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  db.query(
    'INSERT INTO promo_codes (code, discount_percent, expires_at, is_active) VALUES (?, ?, ?, ?)',
    [code, discountPercent, expiresAt || null, isActive !== undefined ? isActive : true],
    (err, result) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      res.status(201).json({ id: result.insertId, code, discount_percent: discountPercent, expires_at: expiresAt || null, is_active: isActive !== undefined ? isActive : true });
    }
  );
});

app.put('/promo-codes/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  const { code, discountPercent, expiresAt, isActive } = req.body;
  if (!code || !discountPercent) return res.status(400).json({ error: '–ö–æ–¥ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  db.query(
    'UPDATE promo_codes SET code = ?, discount_percent = ?, expires_at = ?, is_active = ? WHERE id = ?',
    [code, discountPercent, expiresAt || null, isActive !== undefined ? isActive : true, id],
    (err) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      res.json({ id, code, discount_percent: discountPercent, expires_at: expiresAt || null, is_active: isActive !== undefined ? isActive : true });
    }
  );
});

app.delete('/promo-codes/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('DELETE FROM promo_codes WHERE id = ?', [id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json({ message: '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω' });
  });
});

app.post('/branches', authenticateToken, (req, res) => {
  const { name, address, phone, telegram_chat_id } = req.body;
  if (!name) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
  db.query(
    'INSERT INTO branches (name, address, phone, telegram_chat_id) VALUES (?, ?, ?, ?)',
    [name, address || null, phone || null, telegram_chat_id || null],
    (err, result) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      res.status(201).json({ id: result.insertId, name, address, phone, telegram_chat_id });
    }
  );
});

app.put('/branches/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  const { name, address, phone, telegram_chat_id } = req.body;
  if (!name) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
  db.query(
    'UPDATE branches SET name = ?, address = ?, phone = ?, telegram_chat_id = ? WHERE id = ?',
    [name, address || null, phone || null, telegram_chat_id || null, id],
    (err) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      res.json({ id, name, address, phone, telegram_chat_id });
    }
  );
});

app.delete('/branches/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('DELETE FROM branches WHERE id = ?', [id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json({ message: '–§–∏–ª–∏–∞–ª —É–¥–∞–ª–µ–Ω' });
  });
});

app.post('/categories', authenticateToken, (req, res) => {
  const { name } = req.body;
  if (!name) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
  db.query('INSERT INTO categories (name) VALUES (?)', [name], (err, result) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.status(201).json({ id: result.insertId, name });
  });
});

app.put('/categories/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  const { name } = req.body;
  if (!name) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
  db.query('UPDATE categories SET name = ? WHERE id = ?', [name, id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json({ id, name });
  });
});

app.delete('/categories/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('DELETE FROM categories WHERE id = ?', [id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json({ message: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞' });
  });
});

app.get('/subcategories', authenticateToken, (req, res) => {
  db.query(`
    SELECT s.*, c.name as category_name
    FROM subcategories s
    JOIN categories c ON s.category_id = c.id
  `, (err, subcategories) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(subcategories);
  });
});

app.post('/subcategories', authenticateToken, (req, res) => {
  const { name, categoryId } = req.body;
  if (!name || !categoryId) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  db.query('INSERT INTO subcategories (name, category_id) VALUES (?, ?)', [name, categoryId], (err, result) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    db.query(
      'SELECT s.*, c.name as category_name FROM subcategories s JOIN categories c ON s.category_id = c.id WHERE s.id = ?',
      [result.insertId],
      (err, newSubcategory) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.status(201).json(newSubcategory[0]);
      }
    );
  });
});

app.put('/subcategories/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  const { name, categoryId } = req.body;
  if (!name || !categoryId) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  db.query('UPDATE subcategories SET name = ?, category_id = ? WHERE id = ?', [name, categoryId, id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    db.query(
      'SELECT s.*, c.name as category_name FROM subcategories s JOIN categories c ON s.category_id = c.id WHERE s.id = ?',
      [id],
      (err, updatedSubcategory) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json(updatedSubcategory[0]);
      }
    );
  });
});

app.delete('/subcategories/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('DELETE FROM subcategories WHERE id = ?', [id], (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json({ message: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞' });
  });
});

app.post('/products', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { name, description, priceSmall, priceMedium, priceLarge, priceSingle, branchId, categoryId, subCategoryId, sauceIds } = req.body;
    let imageKey;
    if (!req.file) return res.status(400).json({ error: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    uploadToS3(req.file, (err, key) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
      }
      imageKey = key;
      if (!name || !branchId || !categoryId || !imageKey) {
        return res.status(400).json({ error: '–í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (name, branchId, categoryId, image)' });
      }
      db.query(
        `INSERT INTO products (
          name, description, price_small, price_medium, price_large, price_single,
          branch_id, category_id, sub_category_id, image
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          name,
          description || null,
          priceSmall ? parseFloat(priceSmall) : null,
          priceMedium ? parseFloat(priceMedium) : null,
          priceLarge ? parseFloat(priceLarge) : null,
          priceSingle ? parseFloat(priceSingle) : null,
          branchId,
          categoryId,
          subCategoryId || null,
          imageKey,
        ],
        (err, result) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          // Handle sauces
          if (sauceIds) {
            let sauceIdsArray = [];
            try {
              sauceIdsArray = Array.isArray(sauceIds) ? sauceIds : JSON.parse(sauceIds || '[]');
              if (!Array.isArray(sauceIdsArray)) {
                return res.status(400).json({ error: 'sauceIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' });
              }
            } catch (parseError) {
              console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ sauceIds:', parseError.stack);
              return res.status(400).json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç sauceIds' });
            }
            console.log('sauceIds –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', sauceIdsArray);
            let sauceInsertions = 0;
            if (sauceIdsArray.length === 0) {
              fetchNewProduct();
            } else {
              sauceIdsArray.forEach(sauceId => {
                db.query('SELECT id FROM sauces WHERE id = ?', [sauceId], (err, sauce) => {
                  if (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—É—Å–∞:', err.stack);
                    return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                  }
                  if (sauce.length === 0) {
                    console.warn(`–°–æ—É—Å —Å id ${sauceId} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                    sauceInsertions++;
                    if (sauceInsertions === sauceIdsArray.length) fetchNewProduct();
                    return;
                  }
                  db.query(
                    'INSERT INTO products_sauces (product_id, sauce_id) VALUES (?, ?)',
                    [result.insertId, sauceId],
                    (err) => {
                      if (err) {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—É—Å–∞:', err.stack);
                        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                      }
                      sauceInsertions++;
                      if (sauceInsertions === sauceIdsArray.length) fetchNewProduct();
                    }
                  );
                });
              });
            }
          } else {
            fetchNewProduct();
          }

          function fetchNewProduct() {
            db.query(
              `
              SELECT p.*,
                     b.name as branch_name,
                     c.name as category_name,
                     s.name as subcategory_name,
                     COALESCE(
                       (SELECT JSON_ARRAYAGG(
                         JSON_OBJECT(
                           'id', sa.id,
                           'name', sa.name,
                           'price', sa.price,
                           'image', sa.image
                         )
                       )
                       FROM products_sauces ps
                       LEFT JOIN sauces sa ON ps.sauce_id = sa.id
                       WHERE ps.product_id = p.id AND sa.id IS NOT NULL),
                       '[]'
                     ) as sauces
              FROM products p
              LEFT JOIN branches b ON p.branch_id = b.id
              LEFT JOIN categories c ON p.category_id = c.id
              LEFT JOIN subcategories s ON p.sub_category_id = s.id
              WHERE p.id = ?
              GROUP BY p.id
            `,
              [result.insertId],
              (err, newProduct) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
                  return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                }
                res.status(201).json({
                  ...newProduct[0],
                  sauces: newProduct[0].sauces ? JSON.parse(newProduct[0].sauces).filter(s => s.id) : []
                });
              }
            );
          }
        }
      );
    });
  });
});

app.put('/products/:id', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { id } = req.params;
    const { name, description, priceSmall, priceMedium, priceLarge, priceSingle, branchId, categoryId, subCategoryId, sauceIds } = req.body;
    let imageKey;
    db.query('SELECT image FROM products WHERE id = ?', [id], (err, existing) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (existing.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      if (req.file) {
        uploadToS3(req.file, (err, key) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
          }
          imageKey = key;
          if (existing[0].image) {
            deleteFromS3(existing[0].image, (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
              }
              updateProduct();
            });
          } else {
            updateProduct();
          }
        });
      } else {
        imageKey = existing[0].image;
        updateProduct();
      }

      function updateProduct() {
        db.query(
          `UPDATE products SET
            name = ?, description = ?, price_small = ?, price_medium = ?, price_large = ?,
            price_single = ?, branch_id = ?, category_id = ?, sub_category_id = ?, image = ?
          WHERE id = ?`,
          [
            name,
            description || null,
            priceSmall ? parseFloat(priceSmall) : null,
            priceMedium ? parseFloat(priceMedium) : null,
            priceLarge ? parseFloat(priceLarge) : null,
            priceSingle ? parseFloat(priceSingle) : null,
            branchId,
            categoryId,
            subCategoryId || null,
            imageKey,
            id,
          ],
          (err) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            db.query('DELETE FROM products_sauces WHERE product_id = ?', [id], (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—É—Å–æ–≤:', err.stack);
                return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
              }
              if (sauceIds) {
                let sauceIdsArray = [];
                try {
                  sauceIdsArray = Array.isArray(sauceIds) ? sauceIds : JSON.parse(sauceIds || '[]');
                  if (!Array.isArray(sauceIdsArray)) {
                    return res.status(400).json({ error: 'sauceIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' });
                  }
                } catch (parseError) {
                  console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ sauceIds:', parseError.stack);
                  return res.status(400).json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç sauceIds' });
                }
                console.log('sauceIds –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', sauceIdsArray);
                let sauceInsertions = 0;
                if (sauceIdsArray.length === 0) {
                  fetchUpdatedProduct();
                } else {
                  sauceIdsArray.forEach(sauceId => {
                    db.query('SELECT id FROM sauces WHERE id = ?', [sauceId], (err, sauce) => {
                      if (err) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—É—Å–∞:', err.stack);
                        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                      }
                      if (sauce.length === 0) {
                        console.warn(`–°–æ—É—Å —Å id ${sauceId} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                        sauceInsertions++;
                        if (sauceInsertions === sauceIdsArray.length) fetchUpdatedProduct();
                        return;
                      }
                      db.query(
                        'INSERT INTO products_sauces (product_id, sauce_id) VALUES (?, ?)',
                        [id, sauceId],
                        (err) => {
                          if (err) {
                            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—É—Å–∞:', err.stack);
                            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                          }
                          sauceInsertions++;
                          if (sauceInsertions === sauceIdsArray.length) fetchUpdatedProduct();
                        }
                      );
                    });
                  });
                }
              } else {
                fetchUpdatedProduct();
              }
            });
          }
        );
      }

      function fetchUpdatedProduct() {
        db.query(
          `
          SELECT p.*,
                 b.name as branch_name,
                 c.name as category_name,
                 s.name as subcategory_name,
                 COALESCE(
                   (SELECT JSON_ARRAYAGG(
                     JSON_OBJECT(
                       'id', sa.id,
                       'name', sa.name,
                       'price', sa.price,
                       'image', sa.image
                     )
                   )
                   FROM products_sauces ps
                   LEFT JOIN sauces sa ON ps.sauce_id = sa.id
                   WHERE ps.product_id = p.id AND sa.id IS NOT NULL),
                   '[]'
                 ) as sauces
          FROM products p
          LEFT JOIN branches b ON p.branch_id = b.id
          LEFT JOIN categories c ON p.category_id = c.id
          LEFT JOIN subcategories s ON p.sub_category_id = s.id
          WHERE p.id = ?
          GROUP BY p.id
        `,
          [id],
          (err, updatedProduct) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            res.json({
              ...updatedProduct[0],
              sauces: updatedProduct[0].sauces ? JSON.parse(updatedProduct[0].sauces).filter(s => s.id) : []
            });
          }
        );
      }
    });
  });
});

app.delete('/products/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('SELECT image FROM products WHERE id = ?', [id], (err, product) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (product.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    if (product[0].image) {
      deleteFromS3(product[0].image, (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
        }
        deleteProduct();
      });
    } else {
      deleteProduct();
    }

    function deleteProduct() {
      db.query('DELETE FROM products WHERE id = ?', [id], (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json({ message: '–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω' });
      });
    }
  });
});

app.post('/discounts', authenticateToken, (req, res) => {
  const { productId, discountPercent, expiresAt, isActive } = req.body;
  if (!productId || !discountPercent) return res.status(400).json({ error: 'ID –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  if (discountPercent < 1 || discountPercent > 100) return res.status(400).json({ error: '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 100' });
  db.query('SELECT id FROM products WHERE id = ?', [productId], (err, product) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (product.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    db.query(`
      SELECT id FROM discounts
      WHERE product_id = ? AND is_active = TRUE AND (expires_at IS NULL OR expires_at > NOW())
    `, [productId], (err, existingDiscount) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∫–∏–¥–∫–∏:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (existingDiscount.length > 0) {
        return res.status(400).json({ error: '–î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞—è —Å–∫–∏–¥–∫–∞' });
      }
      db.query(
        'INSERT INTO discounts (product_id, discount_percent, expires_at, is_active) VALUES (?, ?, ?, ?)',
        [productId, discountPercent, expiresAt || null, isActive !== undefined ? isActive : true],
        (err, result) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–∫–∏–¥–∫–∏:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          db.query(
            `SELECT d.*, p.name as product_name
            FROM discounts d
            JOIN products p ON d.product_id = p.id
            WHERE d.id = ?`,
            [result.insertId],
            (err, newDiscount) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å–∫–∏–¥–∫–∏:', err.stack);
                return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
              }
              res.status(201).json(newDiscount[0]);
            }
          );
        }
      );
    });
  });
});

app.put('/discounts/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  const { productId, discountPercent, expiresAt, isActive } = req.body;
  if (!productId || !discountPercent) return res.status(400).json({ error: 'ID –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  if (discountPercent < 1 || discountPercent > 100) return res.status(400).json({ error: '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 100' });
  db.query('SELECT product_id FROM discounts WHERE id = ?', [id], (err, discount) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–∏–¥–∫–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (discount.length === 0) return res.status(404).json({ error: '–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
    db.query('SELECT id FROM products WHERE id = ?', [productId], (err, product) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (product.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      if (discount[0].product_id !== productId) {
        db.query(`
          SELECT id FROM discounts
          WHERE product_id = ? AND id != ? AND is_active = TRUE AND (expires_at IS NULL OR expires_at > NOW())
        `, [productId, id], (err, existingDiscount) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∫–∏–¥–∫–∏:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          if (existingDiscount.length > 0) {
            return res.status(400).json({ error: '–î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥—Ä—É–≥–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è —Å–∫–∏–¥–∫–∞' });
          }
          updateDiscount();
        });
      } else {
        updateDiscount();
      }

      function updateDiscount() {
        db.query(
          'UPDATE discounts SET product_id = ?, discount_percent = ?, expires_at = ?, is_active = ? WHERE id = ?',
          [productId, discountPercent, expiresAt || null, isActive !== undefined ? isActive : true, id],
          (err) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫–∏–¥–∫–∏:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            db.query(
              `SELECT d.*, p.name as product_name
              FROM discounts d
              JOIN products p ON d.product_id = p.id
              WHERE d.id = ?`,
              [id],
              (err, updatedDiscount) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏:', err.stack);
                  return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                }
                res.json(updatedDiscount[0]);
              }
            );
          }
        );
      }
    });
  });
});

app.delete('/discounts/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query(
    `SELECT d.*, p.name as product_name
    FROM discounts d
    JOIN products p ON d.product_id = p.id
    WHERE d.id = ?`,
    [id],
    (err, discount) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–∏–¥–∫–∏:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (discount.length === 0) return res.status(404).json({ error: '–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
      db.query('DELETE FROM discounts WHERE id = ?', [id], (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∫–∏–¥–∫–∏:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json({ message: '–°–∫–∏–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞', product: { id: discount[0].product_id, name: discount[0].product_name } });
      });
    }
  );
});

app.post('/banners', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { title, description, button_text, promo_code_id } = req.body;
    let imageKey;
    if (!req.file) return res.status(400).json({ error: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    uploadToS3(req.file, (err, key) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
      }
      imageKey = key;
      if (promo_code_id) {
        db.query('SELECT id FROM promo_codes WHERE id = ?', [promo_code_id], (err, promo) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          if (promo.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          insertBanner();
        });
      } else {
        insertBanner();
      }

      function insertBanner() {
        db.query(
          'INSERT INTO banners (image, title, description, button_text, promo_code_id) VALUES (?, ?, ?, ?, ?)',
          [imageKey, title || null, description || null, button_text || null, promo_code_id || null],
          (err, result) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            db.query(
              `SELECT b.*, pc.code AS promo_code, pc.discount_percent
              FROM banners b
              LEFT JOIN promo_codes pc ON b.promo_code_id = pc.id
              WHERE b.id = ?`,
              [result.insertId],
              (err, newBanner) => {
                if (err) {
                  console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
                  return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                }
                res.status(201).json({
                  ...newBanner[0],
                  image: `https://nukesul-brepb-651f.twc1.net/product-image/${newBanner[0].image.split('/').pop()}`
                });
              }
            );
          }
        );
      }
    });
  });
});

app.put('/banners/:id', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { id } = req.params;
    const { title, description, button_text, promo_code_id } = req.body;
    let imageKey;

    db.query('SELECT image FROM banners WHERE id = ?', [id], (err, existing) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (existing.length === 0) return res.status(404).json({ error: '–ë–∞–Ω–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });

      if (req.file) {
        uploadToS3(req.file, (err, key) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
          }
          imageKey = key;
          if (existing[0].image) {
            deleteFromS3(existing[0].image, (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
              }
              updateBanner();
            });
          } else {
            updateBanner();
          }
        });
      } else {
        imageKey = existing[0].image;
        updateBanner();
      }

      function updateBanner() {
        if (promo_code_id) {
          db.query('SELECT id FROM promo_codes WHERE id = ?', [promo_code_id], (err, promo) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            if (promo.length === 0) return res.status(404).json({ error: '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
            performUpdate();
          });
        } else {
          performUpdate();
        }

        function performUpdate() {
          db.query(
            'UPDATE banners SET image = ?, title = ?, description = ?, button_text = ?, promo_code_id = ? WHERE id = ?',
            [imageKey, title || null, description || null, button_text || null, promo_code_id || null, id],
            (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
                return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
              }
              db.query(
                `SELECT b.*, pc.code AS promo_code, pc.discount_percent
                FROM banners b
                LEFT JOIN promo_codes pc ON b.promo_code_id = pc.id
                WHERE b.id = ?`,
                [id],
                (err, updatedBanner) => {
                  if (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
                    return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
                  }
                  res.json({
                    ...updatedBanner[0],
                    image: `https://nukesul-brepb-651f.twc1.net/product-image/${updatedBanner[0].image.split('/').pop()}`
                  });
                }
              );
            }
          );
        }
      }
    });
  });
});

app.delete('/banners/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('SELECT image FROM banners WHERE id = ?', [id], (err, banner) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (banner.length === 0) return res.status(404).json({ error: '–ë–∞–Ω–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    if (banner[0].image) {
      deleteFromS3(banner[0].image, (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
        }
        deleteBanner();
      });
    } else {
      deleteBanner();
    }

    function deleteBanner() {
      db.query('DELETE FROM banners WHERE id = ?', [id], (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–∞–Ω–Ω–µ—Ä–∞:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json({ message: '–ë–∞–Ω–Ω–µ—Ä —É–¥–∞–ª–µ–Ω' });
      });
    }
  });
});

app.post('/stories', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    if (!req.file) return res.status(400).json({ error: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    uploadToS3(req.file, (err, imageKey) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
      }
      db.query('INSERT INTO stories (image) VALUES (?)', [imageKey], (err, result) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.status(201).json({
          id: result.insertId,
          image: `https://nukesul-brepb-651f.twc1.net/product-image/${imageKey.split('/').pop()}`,
          created_at: new Date()
        });
      });
    });
  });
});

app.delete('/stories/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('SELECT image FROM stories WHERE id = ?', [id], (err, story) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (story.length === 0) return res.status(404).json({ error: '–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
    if (story[0].image) {
      deleteFromS3(story[0].image, (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
        }
        deleteStory();
      });
    } else {
      deleteStory();
    }

    function deleteStory() {
      db.query('DELETE FROM stories WHERE id = ?', [id], (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json({ message: '–ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞' });
      });
    }
  });
});

app.post('/sauces', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { name, price } = req.body;
    let imageKey = null;
    if (!name || !price) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    if (req.file) {
      uploadToS3(req.file, (err, key) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
        }
        imageKey = key;
        insertSauce();
      });
    } else {
      insertSauce();
    }

    function insertSauce() {
      db.query(
        'INSERT INTO sauces (name, price, image) VALUES (?, ?, ?)',
        [name, parseFloat(price), imageKey],
        (err, result) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ—É—Å–∞:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          res.status(201).json({
            id: result.insertId,
            name,
            price: parseFloat(price),
            image: imageKey ? `https://nukesul-brepb-651f.twc1.net/product-image/${imageKey.split('/').pop()}` : null,
            created_at: new Date()
          });
        }
      );
    }
  });
});

app.put('/sauces/:id', authenticateToken, (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
      return res.status(400).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}` });
    }
    const { id } = req.params;
    const { name, price } = req.body;
    let imageKey;
    if (!name || !price) return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    db.query('SELECT image FROM sauces WHERE id = ?', [id], (err, existing) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—É—Å–∞:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (existing.length === 0) return res.status(404).json({ error: '–°–æ—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      if (req.file) {
        uploadToS3(req.file, (err, key) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ S3:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: ${err.message}` });
          }
          imageKey = key;
          if (existing[0].image) {
            deleteFromS3(existing[0].image, (err) => {
              if (err) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
              }
              updateSauce();
            });
          } else {
            updateSauce();
          }
        });
      } else {
        imageKey = existing[0].image;
        updateSauce();
      }

      function updateSauce() {
        db.query(
          'UPDATE sauces SET name = ?, price = ?, image = ? WHERE id = ?',
          [name, parseFloat(price), imageKey, id],
          (err) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—É—Å–∞:', err.stack);
              return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
            }
            res.json({
              id,
              name,
              price: parseFloat(price),
              image: imageKey ? `https://nukesul-brepb-651f.twc1.net/product-image/${imageKey.split('/').pop()}` : null,
              created_at: existing[0].created_at
            });
          }
        );
      }
    });
  });
});

app.delete('/sauces/:id', authenticateToken, (req, res) => {
  const { id } = req.params;
  db.query('SELECT image FROM sauces WHERE id = ?', [id], (err, sauce) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—É—Å–∞:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (sauce.length === 0) return res.status(404).json({ error: '–°–æ—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    if (sauce[0].image) {
      deleteFromS3(sauce[0].image, (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err.stack);
        }
        deleteSauce();
      });
    } else {
      deleteSauce();
    }

    function deleteSauce() {
      db.query('DELETE FROM sauces WHERE id = ?', [id], (err) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—É—Å–∞:', err.stack);
          return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
        }
        res.json({ message: '–°–æ—É—Å —É–¥–∞–ª–µ–Ω' });
      });
    }
  });
});

app.post('/register', (req, res) => {
  const { name, email, password } = req.body;
  if (!name || !email || !password) return res.status(400).json({ error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
  db.query('SELECT * FROM users WHERE email = ?', [email], (err, users) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (users.length > 0) return res.status(400).json({ error: 'Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' });
    bcrypt.hash(password, 10, (err, hashedPassword) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      db.query(
        'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
        [name, email, hashedPassword],
        (err, result) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err.stack);
            return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
          }
          const token = jwt.sign({ id: result.insertId, email }, JWT_SECRET, { expiresIn: '1h' });
          res.status(201).json({ token, user: { id: result.insertId, name, email } });
        }
      );
    });
  });
});

app.post('/login', (req, res) => {
  const { email, password } = req.body;
  if (!email || !password) return res.status(400).json({ error: '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å' });
  db.query('SELECT * FROM users WHERE email = ?', [email], (err, users) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    if (users.length === 0) return res.status(401).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
    const user = users[0];
    bcrypt.compare(password, user.password, (err, isMatch) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', err.stack);
        return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
      }
      if (!isMatch) return res.status(401).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
      const token = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '1h' });
      res.json({ token, user: { id: user.id, name: user.name, email: user.email } });
    });
  });
});

app.get('/users', authenticateToken, (req, res) => {
  db.query('SELECT id, name, email FROM users', (err, users) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err.stack);
      return res.status(500).json({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${err.message}` });
    }
    res.json(users);
  });
});

// Start server
initializeServer((err) => {
  if (err) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞:', err.stack);
    process.exit(1);
  }
  const PORT = process.env.PORT || 3000;
  app.listen(PORT, () => {
    console.log(`–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
  });
});